#!/usr/bin/env bash
# Given a C litmus test and its fuzzed equivalent, this script checks
# to see if the behaviours of one are included in the behaviours of the other.
#
# For usage information, scroll down to the `usage` function.

set -o errexit
set -o pipefail
set -o nounset

SCRIPTDIR="${SCRIPTDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"}"
readonly SCRIPTDIR

# shellcheck source=scripts/act_bash/exec.sh
source "${SCRIPTDIR}/act_bash/exec.sh"
# shellcheck source=scripts/act_bash/log.sh
source "${SCRIPTDIR}/act_bash/log.sh"


## Constants and arguments ##


# The backend ID to use to get state sets.
BACKEND="herd"

# The name of the compiler to compile through (using obj_splitmus).
# If empty, we don't compile, we just run straight through the backend.
COMPILER=""

# Whether or not we're running ACT programs through `dune exec`.
DUNE_EXEC="false"

# Whether or not verbose logging is enabled.
VERBOSE="false"


## Functions ##


# Prints usage information and exits.
usage() {
  echo "Usage: $0 [-b BACKEND] [-d DIR_NAME] [-qvxh?] ORIGINAL FUZZED"
  echo
  echo "-b: ID of backend to use for simulating C files"
  echo "-d: override autogenerated directory name"
  echo "-v/-q: verbose/quiet"
  echo '-x: run ACT binaries with `dune exec`'
  echo "-h/-?: usage"
  exit
}


main() {
  while getopts "b:c:qvx?h" a; do
    case ${a} in
    b) BACKEND=${OPTARG} ;;
    c) COMPILER=${OPTARG} ;;
    q) VERBOSE="false" ;;
    v) VERBOSE="true" ;;
    x) DUNE_EXEC="true" ;;
    h|?) usage ;;
    esac
  done
  readonly BACKEND COMPILER DUNE_EXEC VERBOSE
  shift $((OPTIND-1))

  if [[ ${DUNE_EXEC} = "true" ]]; then
    act::log "%s: using 'dune exec' for ACT.\n" "$0"
  fi

  if [[ $# -ne 2 ]]; then
    echo "${0}: need precisely two file arguments"
    usage
  fi
  local original_file=$1
  local fuzzed_file=$2

  local flags="-q"
  if [[ ${VERBOSE} == "true" ]]; then flags="-v"; fi
  if [[ ${DUNE_EXEC} == "true" ]]; then flags="${flags}x"; fi

  act::state diff \
    <("${SCRIPTDIR}/c_states" -b "${BACKEND}" -c "${COMPILER}" "${flags}" "${original_file}") \
    <("${SCRIPTDIR}/c_states" -b "${BACKEND}" -c "${COMPILER}" "${flags}" "${fuzzed_file}")
}


## Entry point ##
main "${@}"
