#!/usr/bin/env python3
# The Automagic Compiler Tormentor
#
# Copyright (c) 2018--2019 Matt Windsor and contributors
#
# ACT itself is licensed under the MIT License. See the LICENSE file in the
# project root for more information.
#
# ACT is based in part on code from the Herdtools7 project
# (https://github.com/herd/herdtools7) : see the LICENSE.herd file in the
# project root for more information.
"""Low-level interface onto the test runner.

This script accepts a compiler test expressed as a JSON specification,
runs it, and emits results (errors and states) in the specified directory
structure.

To create a JSON specification, use `make_test`.
"""


import argparse
import typing

from act_py import args as a, io_utils, test, test_runner


def run_from_spec_file(fp: typing.TextIO) -> None:
    """Loads a test specification JSON file from `fp`, and runs the resulting test.

    :param fp: The file-pointer from which we load the JSON.
    """
    t = test.load(fp)
    runner = test_runner.Runner()
    runner.run(t)


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description=__doc__, parents=[a.test_phase_parser])
    args = parser.parse_args()

    io_utils.config_logger(args.log)
    run_from_spec_file(args.test)
